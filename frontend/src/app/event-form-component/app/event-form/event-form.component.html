<div class="container py-4 custom-form-width">
  <form (ngSubmit)="submitForm()" autocomplete="off" class="d-flex flex-column gap-3">

    <h2 class="text-center fw-bold mb-3">Je crÃ©e une activitÃ©</h2>

    <!-- Ã‰tape 1 : Informations de base -->
    <div *ngIf="currentStep === 1">

      <!-- Tag -->
      <div>
        <label class="form-label fw-bold">Tag</label>

        <!-- Tags les plus frÃ©quents -->
        <div class="d-flex flex-wrap gap-2 mb-2">
          <span
            *ngFor="let t of filteredTags"
            (click)="selectTag(t)"
            class="badge px-3 py-2"
            [ngClass]="{
              'bg-warning text-dark': event.tag === t,
              'bg-light border text-dark': event.tag !== t
            }"
            style="cursor: pointer"
          >
            {{ t }}
          </span>
        </div>

        <!-- Barre de recherche -->
        <input
          type="text"
          class="form-control"
          placeholder="Rechercher un tag..."
          [(ngModel)]="searchTag"
          (ngModelChange)="onSearchTagChange()"
        />
      </div>
      <div *ngIf="tagMissingError" class="text-danger small mt-1">
        Vous devez sÃ©lectionner un tag pour votre activitÃ©.
      </div>

      <!-- Description -->
      <div>
        <label class="form-label fw-bold mt-3">Description</label>
        <textarea class="form-control" [(ngModel)]="event.description" name="description"
          placeholder="Ex: Session libre pour joueurs de tous niveaux" (ngModelChange)="onDescriptionChange()" autoResize
  style="overflow: hidden; resize: none;"></textarea>
        <!-- Bouton pour afficher/masquer les emojis -->
        <div class="mt-2 position-relative">
          <button type="button" class="btn btn-sm btn-outline-secondary" (click)="toggleEmojiPanel()">
            ğŸ˜Š Ajouter un emoji
          </button>

          <!-- Liste d'emojis -->
          <div *ngIf="showEmojiList" class="border rounded p-2 mt-2 bg-light emoji-list" style="max-width: 300px;">
            <span
              *ngFor="let emoji of emojis"
              (click)="addEmoji(emoji)"
              style="cursor: pointer; font-size: 1.4rem; margin-right: 6px;"
            >
              {{ emoji }}
            </span>
          </div>
        </div>
        <span [class.text-danger]="event.description?.length > maxDescriptionLength">
          {{ event.description?.length || 0 }}/{{ maxDescriptionLength }}
        </span>
      </div>
      <div class="d-flex justify-content-between small mt-1">
        <span *ngIf="descriptionError" class="text-danger">La description est obligatoire (10â€“500 caractÃ¨res).</span>
      </div>

      <div class="row g-3 mt-3">
        <!-- Date -->
        <div class="col-md-3">
          <label class="form-label fw-bold">Date</label>
          <input
            class="form-control"
            ngbDatepicker
            name="date"
            [(ngModel)]="event.date"
            #d="ngbDatepicker"
            (click)="d.toggle()"
            [minDate]="minDate"
            placeholder="jj/mm/aaaa"
            (ngModelChange)="onDateOrTimeChange()"
          />
        </div>

        <!-- Heure de dÃ©but -->
        <div class="col-md-3">
          <label class="form-label fw-bold">Heure dÃ©but</label>
          <input
            type="time"
            lang="fr"
            class="form-control"
            [(ngModel)]="event.startTime"
            name="startTime"
            [min]="getMinStartTime()"
            required
            (ngModelChange)="onDateOrTimeChange()"
          />
        </div>

        <!-- Heure de fin -->
        <div class="col-md-3">
          <label class="form-label fw-bold">Heure fin</label>
          <input
            type="time"
            lang="fr"
            class="form-control"
            [(ngModel)]="event.endTime"
            name="endTime"
          />
          <small class="text-muted">Facultatif</small>
        </div>
      </div>


      <div *ngIf="dateOrTimeMissingError" class="text-danger small mt-1">
        La date et lâ€™heure de dÃ©but sont obligatoires.
      </div>
      <div *ngIf="dateInPastError" class="text-danger small mt-1">
        La date et lâ€™heure de dÃ©but doivent Ãªtre dans le futur.
      </div>
      <div *ngIf="timeRangeError" class="text-danger small mt-1">
        Lâ€™heure de fin doit Ãªtre postÃ©rieure Ã  lâ€™heure de dÃ©but.
      </div>

      <!-- Lieu avec autocomplÃ©tion -->
      <div>
        <label class="form-label fw-bold">ğŸ“ Lieu</label>
        <input
          #searchInput
          type="text"
          class="form-control"
          placeholder="Rechercher un lieu (ex: CafÃ© Auguste)"
        />
      </div>
      <!-- Adresse rÃ©cupÃ©rÃ©e automatiquement -->
      <div *ngIf="event.address">
        <label class="form-label mt-2">Adresse dÃ©tectÃ©e</label>
        <input class="form-control" [value]="event.address" readonly />
      </div>
      <div *ngIf="locationError" class="text-danger small mt-1">
        Le lieu est obligatoire. Veuillez sÃ©lectionner un lieu dans la liste.
      </div>

      <button type="button" class="btn btn-primary w-100 mt-4" (click)="nextStep()">Suivant</button>
    </div>

    <!-- Ã‰tape 2 : Options avancÃ©es -->
    <div *ngIf="currentStep === 2">
      <!-- Participants -->
      <div>
        <label class="form-label fw-bold d-block">Participants</label>
        <div class="d-flex gap-3">
          <div class="flex-fill">
            <label>Min</label>
            <input type="number" class="form-control" [(ngModel)]="event.minParticipants" name="minParticipants" (ngModelChange)="onParticipantsMinChange()" />
          </div>
          <div class="flex-fill">
            <label>Max</label>
            <input type="number" class="form-control" [(ngModel)]="event.maxParticipants" name="maxParticipants" (ngModelChange)="onParticipantsMaxChange()" />
          </div>
        </div>
      </div>
      <div *ngIf="participantRangeError" class="text-danger small mt-1">
        Le nombre maximum de participants doit Ãªtre supÃ©rieur ou Ã©gal au minimum.
      </div>
      <div *ngIf="minParticipantsError" class="text-danger small mt-1">
        Le nombre minimum de participants doit Ãªtre compris entre 2 et 100.
      </div>
      <div *ngIf="maxParticipantsError" class="text-danger small mt-1">
        Le nombre maximum de participants doit Ãªtre compris entre 2 et 100.
      </div>

      <!-- Ã‚ges -->
      <div>
        <label class="form-label fw-bold mt-3">Tranche d'Ã¢ge</label>
        <div class="d-flex gap-3">
          <div class="flex-fill">
            <label>Ã‚ge min</label>
            <input type="number" class="form-control" [(ngModel)]="event.minAge" name="minAge" min="16" (ngModelChange)="onAgeMinChange()" />
          </div>
          <div class="flex-fill">
            <label>Ã‚ge max</label>
            <input type="number" class="form-control" [(ngModel)]="event.maxAge" name="maxAge" (ngModelChange)="onAgeMaxChange()" />
          </div>
        </div>
      </div>
      <div *ngIf="ageRangeError" class="text-danger small mt-1">
        L'Ã¢ge maximum doit Ãªtre supÃ©rieur ou Ã©gal Ã  l'Ã¢ge minimum.
      </div>
      <div *ngIf="userAgeOutOfRangeError" class="text-danger small mt-1">
        Votre Ã¢ge nâ€™est pas compris dans la tranche dÃ©finie pour cette activitÃ©.
      </div>
      <div *ngIf="minAgeError" class="text-danger small mt-1">
        L'Ã¢ge minimum doit Ãªtre compris entre 16 et 100 ans.
      </div>


      <!-- Contraintes de genre -->
      <div class="mt-3">
        <label class="form-label fw-bold">Contraintes de genre</label>
        <select class="form-select" [(ngModel)]="event.genderRequirement" name="genderRequirement">
          <option *ngFor="let option of genderOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- VisibilitÃ© -->
      <div class="mt-3">
        <label class="form-label fw-bold">VisibilitÃ©</label>
        <select class="form-select" [(ngModel)]="event.visibility" name="visibility" (change)="onVisibilityChange()">
          <option value="PUBLIC">Public (par dÃ©faut)</option>
          <option value="FRIENDS_ONLY">ğŸ‘¥ PrivÃ© â€“ rÃ©servÃ© Ã  mes contacts</option>
          <option value="GROUP">ğŸ‘¥ PrivÃ© â€“ sÃ©lectionner un groupe</option>
          <option value="CUSTOM">ğŸ‘¥ PrivÃ© â€“ sÃ©lectionner des contacts</option>
        </select>
      </div>
      <!-- Groupe concernÃ© -->
      <div *ngIf="event.visibility === 'GROUP'">
        <ng-container *ngIf="myGroups.length > 0; else noGroup">
          <label class="form-label fw-bold">Groupe concernÃ© :</label>
          <select class="form-select" [(ngModel)]="event.groupId" name="groupId">
            <option *ngFor="let g of myGroups" [value]="g.id">{{ g.name }}</option>
          </select>
        </ng-container>
        <ng-template #noGroup>
          <div class="alert alert-warning small mt-2">
            âš ï¸ Vous nâ€™avez encore crÃ©Ã© ou rejoint aucun groupe.
          </div>
        </ng-template>
      </div>
      <div *ngIf="groupSelectionError" class="text-danger small mt-1">
        âš ï¸ Veuillez sÃ©lectionner un groupe.
      </div>


      <!-- SÃ©lection de contacts -->
      <div *ngIf="event.visibility === 'CUSTOM'">
        <ng-container *ngIf="myContacts.length > 0; else noContact">
          <label class="form-label fw-bold">Inviter des contacts :</label>
          <select class="form-select" [(ngModel)]="event.invitedUserIds" name="invitedUserIds" multiple>
            <option *ngFor="let c of myContacts" [value]="c.id">
              {{ c.firstName }} {{ c.lastName }}
            </option>
          </select>
        </ng-container>
        <ng-template #noContact>
          <div class="alert alert-warning small mt-2">
            âš ï¸ Vous nâ€™avez encore ajoutÃ© aucun contact.
          </div>
        </ng-template>
      </div>
      <div *ngIf="invitedContactsError" class="text-danger small mt-1">
        âš ï¸ Veuillez sÃ©lectionner au moins un contact.
      </div>


      <!-- Ajouter une photo -->
      <div class="text-center mt-3">
        <label class="btn border w-100 p-3" style="cursor: pointer;">
          <span class="fw-bold text-dark">
            â• <strong>Ajouter une photo</strong> liÃ©e Ã  lâ€™Ã©vÃ©nement <small>(facultatif)</small>
          </span>
          <input type="file" accept="image/*" (change)="onFileSelected($event)" hidden #fileInput />
        </label>

        <div *ngIf="previewUrl" class="mt-3">
          <img [src]="previewUrl" alt="PrÃ©visualisation" style="max-width: 100%; border-radius: 10px;" />
        </div>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-secondary" (click)="previousStep()">â† PrÃ©cÃ©dent</button>
        <button type="submit" class="btn btn-warning" [disabled]="loading">
          <span *ngIf="!loading">CrÃ©er</span>
          <span *ngIf="loading" class="spinner-border spinner-border-sm"></span>
        </button>
      </div>
    </div>

    <!-- Message succÃ¨s -->
    <div *ngIf="successMessage" class="alert alert-success text-center">
      âœ… Ã‰vÃ©nement crÃ©Ã© avec succÃ¨s !
    </div>
  </form>
</div>
